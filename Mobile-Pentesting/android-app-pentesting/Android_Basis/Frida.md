Frida is a great toolkit by @oleavr, used to build tools for dynamic instrumentation of apps in userspace. It is often used, like Substrate, Xposed and similar frameworks, during security reviews of mobile applications.

![](media/1e7b7f86f6617b41e2777230912e1818.png)

![](media/5b570571becba0882b655bb4a6e27764.png)

![](media/8b3aed454d9c073c10eba6eb2fd2d017.png)

![](media/0b452ebb7268fe2f1fc4d8ca38849dab.png)

![](media/f99846a780608a439cf9b6ae01038168.png)

![](media/00f90888d0535638038ed0b0d7b332d4.png)

![](media/21c3caacea1fcbac1e153cbf4fecc16f.png)

![](media/9e6e57f2692c877fdb1831a2c3276407.png)

Root Detection Bypass:

![](media/2a49fe746b00cbcabe17c71e95a203db.png)

![](media/0af00d67c5735788238ccb17c8d82b0d.png)

![](media/ba9e574594343316bc40fcf88040f91d.png)

Certificate Pinning:

![](media/8cea03ec440763af84828ade14d8ccec.png)

![](media/09ec969ae6856e840048df14cabdf7cf.png)

![](media/0352f986dc28e5661211e2bb67526e98.png)

![](media/5973cc950c0e6fd0f97e1458b36bb575.png)

![](media/1ae3855f4da67b61f9933752d5b016f9.png)

![](media/9cf2cc4a1e9c695a6aa8558aacbc3589.png)

Typically rooted Android devices are used during such reviews. There are several reasons for this, but the most important is that the frida-server binary, which executes on the device, requires root privileges to attach to (ptrace) the target application, in order to inject the Frida gadget library into the memory space of the process.

However, testing on a rooted device is not the only way! I am not sure why this technique is not more widely publicized, but Frida can also be used on non-rooted Android devices and non-jailbroken iPhones, without running frida-server at all. In this post I will focus on Android, however things are pretty similar on iOS - frida can also be used on jailed Apple devices.

A few advantages of using Frida on a non-rooted device:

Enables testing on devices you cannot or do not want to root (obviously).

Avoids some sideeffects due to application checks for ptracing/debugging or checks for tampered environment.

Adding frida-gadget to an Android application

The technique is simple, it can be described in short as “adding a shared library & repackaging the Android application”. Here it is, step by step:

1\. Get the the APK binary of te application you want to test, e.g. myapp.apk.

2\. Use apktool to decode the APK into it’s contents. Preferably its latest version.

\$ apktool d myapp.apk -o extractedFolder

3\. Add the frida native libraries (frida-gadget) into the APK’s /lib folder. The gadget libraries for each architecture can be found in Frida’s release page. Make sure to add the libraries for the correct architecture in a suitable folder under /lib, e.g. /lib/armeabi for 32bit ARM devices.

\$ apktool --version

2.2.2

\$ apktool d -o out_dir original.apk

I: Using Apktool 2.2.2 on original.apk

I: Loading resource table...

I: Decoding AndroidManifest.xml with resources...

I: Loading resource table from file: \~/.local/share/apktool/framework/1.apk

I: Regular manifest package...

I: Decoding file-resources...

I: Decoding values XMLs...

I: Baksmaling classes.dex...

I: Copying assets and libs...

I: Copying unknown files...

I: Copying original files...

\# download frida gadget - for 32bit ARM in this case

\$ wget <https://github.com/frida/frida/releases/download/9.1.26/frida-gadget-9.1.26-android-arm.so.xz>

2017-04-11 10:48:45 (3.29 MB/s) - ‘frida-gadget-9.1.26-android-arm.so.xz’ saved [3680748/3680748]

\# extract the compressed archive

\$ unxz frida-gadget-9.1.26-android-arm.so.xz

\$ ls

frida-gadget-9.1.26-android-arm.so

\# copy frida gadget library in armeabi directory under lib

\$ cp frida_libs/armeabi/frida-gadget-9.1.26-android-arm.so out_dir/lib/armeabi/libfrida-gadget.so

Inject a System.loadLibrary("frida-gadget") call into the bytecode of the app, ideally before any other bytecode executes or any native code is loaded. A suitable place is typically the static initializer of the entry point classes of the app, e.g. the main application Activity, found via the manifest.

An easy way to do this is to add the following smali code in a suitable function:

const-string v0, "frida-gadget"

invoke-static {v0}, Ljava/lang/System;-\>loadLibrary(Ljava/lang/String;)V

Alternatively someone could create a script that injects the library into the process via ptrace; but this script would need to be packaged with the application (just like gdbserver).

Add the Internet permission to the manifest if it’s not there already, so that Frida gadget can open a socket.

\<uses-permission android:name="android.permission.INTERNET" /\>

6\. Repackage the application:

\$ apktool b -o repackaged.apk out_dir/

I: Using Apktool 2.2.2

I: Checking whether sources has changed...

I: Smaling smali folder into classes.dex...

I: Checking whether resources has changed...

I: Building resources...

I: Copying libs... (/lib)

I: Building apk file...

I: Copying unknown files/dir...

7\. Sign the updated APK using your own keys and zipalign.

\# if you dont have a keystore already, here's how to create one

\$ keytool -genkey -v -keystore custom.keystore -alias mykeyaliasname -keyalg RSA -keysize 2048 -validity 10000

\# sign the APK

\$ jarsigner -sigalg SHA1withRSA -digestalg SHA1 -keystore mycustom.keystore -storepass mystorepass repackaged.apk mykeyaliasname

\# verify the signature you just created

\$ jarsigner -verify repackaged.apk

\# zipalign the APK

\$ zipalign 4 repackaged.apk repackaged-final.apk

8\. Install the updated APK to a device.

If this process seems complicated, the good news is that it can be automated. As part of the appmon hooking framework (based on Frida) @dpnishant released apk_builder, a script automating most of the above steps!

Using frida gadget

When you next start the application you are going to see an empty screen: The injected libfrida-gadget.so library has opened a tcp socket and waits for a connection from frida.

You should see a message similar to the following in logcat:

Frida: Listening on TCP port 27042

Running nestat on the device confirms the listening socket:

shell@flo:/ \$ netstat -ln

Active Internet connections (only servers)

Proto Recv-Q Send-Q Local Address Foreign Address State

tcp 0 0 127.0.0.1:27042 0.0.0.0:\*

As you might expect, the next step is connecting to the listening socket: Most frida tools work as expected although there are a few issues that can be handled better, e.g. connecting to the library after initialization, not just during loading.

There is just one thing to keep in mind: The process name you are going to use in Frida tooling should be “Gadget” instead of the normal package name.

\$ frida-ps -U

Waiting for USB device to appear...

PID Name

\----- ------

16071 Gadget

\$ frida -U Gadget

\___\_

/ \_ \| Frida 9.1.26 - A world-class dynamic instrumentation framework

\| (_\| \|

\> \_ \| Commands:

/_/ \|_\| help -\> Displays the help system

. . . . object? -\> Display information about 'object'

. . . . exit/quit -\> Exit

. . . .

. . . . More info at <http://www.frida.re/docs/home/>

Waiting for USB device to appear...

[USB::Samsung SM-G925F::Gadget]-\> Java.available

true

[USB::Samsung SM-G925F::Gadget]-\>

\$ frida-trace -U -i open Gadget

Instrumenting functions...

open: Auto-generated handler at "/tmp/test/__handlers__/libc.so/open.js"

Started tracing 1 function. Press Ctrl+C to stop.

/\* TID 0x2df7 \*/

4870 ms open(pathname=0xa280b100, flags=0x241)

4873 ms open(pathname=0xb6d69df3, flags=0x2)

/\* TID 0x33d2 \*/

115198 ms open(pathname=0xb6d69df3, flags=0x2)

115227 ms open(pathname=0xb6d69df3, flags=0x2)

Enjoy!

![](media/03b128dea49b614cc78061484b871326.png)

![](media/f92b29ef7a285cc48a4feafab636d051.png)

![](media/5f00d73577b1da3a37119e520f345ccd.png)

![](media/d9ec4890eba1e7e7d92a155ac0570e44.png)

![](media/d0421a1ec772d7a36d24f926d1b00d14.png)

![](media/5d1c27268b18d6e053905ee774f95768.png)

![](media/caa34a9cf54a7bd69c260a7aa9b1eed4.png)

![](media/c6ae1339ef2dadfa716586cbb94e62e1.png)

![](media/a62732222954c202712c774bd6bb0ed4.png)

![](media/ce87cdcb1f77964472da7e4ff4e57784.png)

![](media/1a8e9e345566449f202b0c9257ca0a16.png)

![](media/7e816c88b02b6baf9d446399fd9b0350.png)

![](media/055bdd10ae9670887bb13817069fe746.png)

![](media/26ce23fbf841dd0260075b2c3e3749f3.png)

![](media/627e31a7869f8c11181845f20111b425.png)

![](media/8ef13c29e79411e7ac0702cc71550462.png)

![](media/badf38f5ef525fba812fc3f83c206ae0.png)

Downloading Frida-server for x86

![](media/46458d241e31cbdfbcf781bede91c1e9.png)

![](media/83829e46d19cd2be97f245f3d948e18a.png)

Put the environment variable

![](media/0f3b46055a4b8b0fc7846db2cabce58b.png)

Checking Frida is running or not

![](media/c678f575e48d20d8c77b2350c1e2ca3c.png)

![](media/0c1f0c835206ca03716890fee8e4623c.png)

![](media/6c36effff143146457a227b2b1a6f13f.png)

![](media/16d6977d6190ba56cf9fedbc8844addf.png)

if the apk is patched with the objection: first we have to setup few things which are unable the developer options and enable usb debugging.

![](media/6b9e2d97ad7d70c1ac0dffb6a5e72766.png)

Root Detection Bypass:

![](media/b04aca3f55d4d9810f23b1f8c46bf1b5.png)

To know which classes are loaded

android hooking list classes

![](media/f6e6eceaa9dde630b0e8931fa75bb5ad.png)

![](media/69874dd962fac9264d4c87f6598c67f5.png)

![](media/3eee024cdb92f30d433d46439289641f.png)

List the methods from the class

![](media/5593bc7c25627892d754e75c41c39893.png)

![](media/f4b1ab4f9fc75a0dcac536d62264fbd4.png)

![](media/0be68373d641f7db3576f60f71d1ba2b.png)

![](media/6c3378d40000b459c82a4d3841fcbfff.png)

![](media/de07b057284f1a71255ffbf921bf89b0.png)

End to end encryption

![](media/8213a18ccbf0feac8f07a0faebd59f0d.png)

![](media/b0d90717d058b78b6f78c0cbb63c260a.png)

android hooking watch class com.androidpentesting.securestorev2.UserMainActivity

android hooking list classes \> classes.txt

android hooking list class_methods com.androidpentesting.securestorev2.UserMainActivity

android hooking list class_methods com.androidpentesting.securestorev2.UserMainActivity

android hooking set return_value com.androidpentesting.securestorev2.UserMainActivity.isDeviceRooted false

\-s "android hooking set return_value com.androidpentesting.securestorev2.UserMainActivity.isDeviceRooted false"

objection --gadget com.androidpentesting.securestorev2 explore -s "android hooking set return_value com.androidpentesting.securestorev2.UserMainActivity.isDeviceRooted false"

objection --gadget com.androidpentesting.securestorev2 explore -s "android root disable"

<https://payatu.com/blog/setup-frida-on-android-application/>

<https://infosecwriteups.com/hail-frida-the-universal-ssl-pinning-bypass-for-android-e9e1d733d29>

Frida-CLI:

![](media/cbd0b7534c8f8dee4201f97d1203d8a1.png)

![](media/c0548505380c98934927fdaa691a5c39.png)

Custom scripting:

![](media/332cf13c797cc3c653c95656b69319ce.png)

![](media/94eadd3f9cd6a923e72dd83517efb2ba.png)

![](media/af9878c4de8721dd50d23ac371614ff2.png)

![](media/300725f4091ce98e1af32de15e05dfa5.png)

![](media/0096541a86d418b28822db80494317ef.png)

![](media/55f3bc84a7dff4a1b567736a51a3b872.png)

![](media/09ea7740f5df23008fe929cc18904f1a.png)

![](media/b15c44b11dbc553a7b4d63ad086506db.png)

![](media/20537ef521b4e6a531c868542238575e.png)
