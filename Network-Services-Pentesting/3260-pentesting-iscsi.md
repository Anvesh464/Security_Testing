# 3260 - Pentesting ISCSI

## Basic Information

> In computing, **iSCSI** is an acronym for **Internet Small Computer Systems Interface**, an Internet Protocol (IP)-based storage networking standard for linking data storage facilities. It provides block-level access to storage devices by carrying SCSI commands over a TCP/IP network. iSCSI is used to facilitate data transfers over intranets and to manage storage over long distances. It can be used to transmit data over local area networks (LANs), wide area networks (WANs), or the Internet and can enable location-independent data storage and retrieval.
>
> The protocol allows clients (called initiators) to send SCSI commands (CDBs) to storage devices (targets) on remote servers. It is a storage area network (SAN) protocol, allowing organizations to consolidate storage into storage arrays while providing clients (such as database and web servers) with the illusion of locally attached SCSI disks. It mainly competes with Fibre Channel, but unlike traditional Fibre Channel which usually requires dedicated cabling, iSCSI can be run over long distances using existing network infrastructure.
>ISCSI (Internet Small Computer System Interface) is a protocol used for establishing and managing connections between storage devices over an IP network. It enables storage devices to be shared and accessed remotely, providing block-level access to storage resources.ISCSI is commonly used in data centers and enterprise environments for storage area networks (SANs) and virtualization deployments.

**Default port:** 3260

```
PORT     STATE SERVICE VERSION
3260/tcp open  iscsi?
```
# Connect
## Connect Using ISCSI Initiator
```
iscsiadm --mode discoverydb --type sendtargets --portal <target-ip>:<target-port> --discover
```
## Connect Using ISCSI Target Portal
You can use tools like ISCSI Initiator or open-iscsi to connect to an ISCSI target portal.

## Recon
Identifying an ISCSI Target
You can use Nmap to check if there's an ISCSI target on a target host like this:
```
nmap -p 3260 X.X.X.X
```
Banner Grabbing
```
nc -nv X.X.X.X 3260
```
## Enumeration

```
nmap -sV --script=iscsi-info -p 3260 192.168.xx.xx
```
## ISCSI Target Information
Connect to the ISCSI target and gather information about available LUNs (Logical Unit Numbers), target IQNs (ISCSI Qualified Names), and other configuration details using ISCSI commands.

## ISCSI Client Tools
Tools like ISCSI Initiator, open-iscsi, and tgtadm can be used for interacting with ISCSI targets and performing enumeration tasks.

# Attack Vectors
## Default Credentials
Check for default credentials or weak authentication configurations in ISCSI targets, such as targets using default IQNs or no authentication.

## Unauthorized Access
Search for open ISCSI targets that allow unrestricted access, which may be exposed to unauthorized access from the internet.

## LUN Manipulation
Exploit vulnerabilities in ISCSI target configurations to access or manipulate LUNs, potentially gaining unauthorized access to sensitive data.

# Post-Exploitation
## Common ISCSI Commands

Command	Description
iscsiadm -m session	List active ISCSI sessions
iscsiadm -m node -l	Log in to an ISCSI target
iscsiadm -m node -u	Log out of an ISCSI target
iscsiadm -m node -o show	Display detailed information about a target
iscsiadm -m discovery	Discover available ISCSI targets

## Data Exfiltration
Extract sensitive data by accessing and manipulating LUNs on the ISCSI target.

## Ransomware Attacks
Encrypt data on the ISCSI target and demand a ransom for decryption, exploiting vulnerabilities in ISCSI target configurations.

## Denial-of-Service (DoS) Attacks
ISCSI targets may be susceptible to DoS attacks, disrupting storage access and causing service downtime.

This script will indicate if authentication is required.

### [Brute force](../generic-hacking/brute-force.md#iscsi)

### [Mount ISCSI on Linux](https://www.synology.com/en-us/knowledgebase/DSM/tutorial/Virtualization/How_to_set_up_and_use_iSCSI_target_on_Linux)

**Note:** You may find that when your targets are discovered, they are listed under a different IP address. This tends to happen if the iSCSI service is exposed via NAT or a virtual IP. In cases like these, `iscsiadmin` will fail to connect. This requires two tweaks: one to the directory name of the node automatically created by your discovery activities, and one to the `default` file contained within this directory.

For example, you are trying to connect to an iSCSI target on 123.123.123.123 at port 3260. The server exposing the iSCSI target is actually at 192.168.1.2 but exposed via NAT. isciadm will register the _internal_ address rather than the _public_ address:

```
iscsiadm -m discovery -t sendtargets -p 123.123.123.123:3260
192.168.1.2:3260,1 iqn.1992-05.com.emc:fl1001433000190000-3-vnxe
[...]
```

### [Mount ISCSI on Windows](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/ee338476\(v=ws.10\)?redirectedfrom=MSDN)

## **Manual enumeration**

```bash
sudo apt-get install open-iscsi
```
First of all you need to **discover the targets** name behind the IP:

```bash
iscsiadm -m discovery -t sendtargets -p 123.123.123.123:3260
123.123.123.123:3260,1 iqn.1992-05.com.emc:fl1001433000190000-3-vnxe
[2a01:211:7b7:1223:211:32ff:fea9:fab9]:3260,1 iqn.2000-01.com.synology:asd3.Target-1.d0280fd382
[fe80::211:3232:fab9:1223]:3260,1 iqn.2000-01.com.synology:Oassdx.Target-1.d0280fd382
```

_Note that it will show the I**P and port of the interfaces** where you can **reach** those **targets**. It can even **show internal IPs or different IPs** from the one you used._

Then you **catch the 2nd part of the printed string of each line** (_iqn.1992-05.com.emc:fl1001433000190000-3-vnxe_ from the first line) and **try to login**:

```bash
iscsiadm -m node --targetname="iqn.1992-05.com.emc:fl1001433000190000-3-vnxe" -p 123.123.123.123:3260 --login
Logging in to [iface: default, target: iqn.1992-05.com.emc:fl1001433000190000-3-vnxe, portal: 123.123.123.123,3260] (multiple)
Login to [iface: default, target: iqn.1992-05.com.emc:fl1001433000190000-3-vnxe, portal: 123.123.123.123,3260] successful.
```

Then, you can **logout** using `â€“logout`

```bash
iscsiadm -m node --targetname="iqn.1992-05.com.emc:fl1001433000190000-3-vnxe" -p 123.123.123.123:3260 --logout
Logging out of session [sid: 6, target: iqn.1992-05.com.emc:fl1001433000190000-3-vnxe, portal: 123.123.123.123,3260]
Logout of [sid: 6, target: iqn.1992-05.com.emc:fl1001433000190000-3-vnxe, portal: 123.123.123.123,3260] successful.
```
## **Shodan**

* `port:3260 AuthMethod`

## **References**

* [https://bitvijays.github.io/LFF-IPS-P2-VulnerabilityAnalysis.html](https://bitvijays.github.io/LFF-IPS-P2-VulnerabilityAnalysis.html)
* [https://ptestmethod.readthedocs.io/en/latest/LFF-IPS-P2-VulnerabilityAnalysis.html#iscsiadm](https://ptestmethod.readthedocs.io/en/latest/LFF-IPS-P2-VulnerabilityAnalysis.html#iscsiadm)
