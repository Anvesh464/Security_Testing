## Basic Information

**MongoDB** is a popular NoSQL database that uses a document-oriented data model. It stores data in flexible, JSON-like documents, meaning fields can vary from document to document and data structure can be changed over time. MongoDB is widely used in modern web applications due to its flexibility, scalability, and performance.

```
PORT      STATE SERVICE VERSION
27017/tcp open  mongodb MongoDB 2.6.9 2.6.9
```
## Connect
Connect Using MongoDB Shell
```
mongo <target-ip>:<port>
```
## Connect Using MongoDB Compass
MongoDB Compass is a GUI tool for interacting with MongoDB databases.
## Recon
### Identifying a MongoDB Server
You can use Nmap to check if there's a MongoDB server on a target host like this:
```
nmap -p 27017 X.X.X.X
```
## Banner Grabbing
You can use Netcat to find out if a MongoDB service is running and its version by looking at the welcome message it shows when you connect. This method is called Banner Grabbing.
```
nc -nv X.X.X.X 27017
```
# Enumeration
## MongoDB Server Information
You can connect to the MongoDB server and gather information about the server, databases, collections, users, etc. using MongoDB commands.

## MongoDB Client Tools
Tools like MongoShell and MongoDump can be used for interacting with MongoDB databases and performing enumeration tasks.

# Attack Vectors
## Default Credentials
MongoDB instances often come with default credentials or no authentication enabled. It's crucial to check for default credentials or weak authentication configurations.

## NoSQL Injection
Similar to SQL Injection in relational databases, NoSQL Injection attacks target MongoDB databases by exploiting vulnerabilities in query constructions.

## Unprotected MongoDB Instances
MongoDB instances sometimes have no access control or firewall rules, leaving them exposed to unauthorized access from the internet. You can search for MongoDB instances using tools like Shodan and exploit them if they're unprotected.

# Post-Exploitation
## Common MongoDB Commands
--------------------------------------------------------------------------------------------------------------
| Command	                        | Description	                        |   Example
------------------------------------|---------------------------------------|--------------------------------
| show dbs	                        | List all databases	                | show dbs
| use <db>                        	| Switch to a specific database	        | use mydatabase
| show collections                	| List all collections in the database	| show collections
| db.collection.find()	            | Retrieve documents from a collection	| db.mycol.find().pretty()
| db.collection.insertOne()	        | Insert a document into a collection	| db.mycol.insertOne({name: "John", age: 30})
| db.collection.deleteOne()	        | Delete a document from a collection	| db.mycol.deleteOne({name: "John"})
| db.dropDatabase()	                | Drop the current database	            | db.dropDatabase()
--------------------------------------------------------------------------------------------------------------------
## Exfiltrating Data
Once you have access to a MongoDB database, you can exfiltrate sensitive data by querying the database and extracting the results.

## Ransomware Attacks
Attackers may encrypt MongoDB databases and demand a ransom for decryption, exploiting vulnerabilities in MongoDB instances.

## Denial-of-Service (DoS) Attacks
MongoDB instances may be susceptible to DoS attacks, disrupting database availability and causing service downtime.

### Manual

```python
from pymongo import MongoClient
client = MongoClient(host, port, username=username, password=password)
client.server_info() #Basic info
#If you have admin access you can obtain more info
admin = client.admin
admin_info = admin.command("serverStatus")
cursor = client.list_databases()
for db in cursor:
    print(db)
    print(client[db["name"]].list_collection_names())
#If admin access, you could dump the database also
```

**Some MongoDB commnads:**

```bash
show dbs
use <db>
show collections
db.<collection>.find()  #Dump the collection
db.<collection>.count() #Number of records of the collection
db.current.find({"username":"admin"})  #Find in current db the username admin
```

### Automatic

```bash
nmap -sV --script "mongo* and default" -p 27017 <IP> #By default all the nmap mongo enumerate scripts are used
```

### Shodan

* All mongodb: `"mongodb server information"`
* Search for full open mongodb servers: `"mongodb server information" -"partially enabled"`
* Only partially enable auth: `"mongodb server information" "partially enabled"`

## Login

By default mongo does not require password.\
**Admin** is a common mongo database.

```bash
mongo <HOST>
mongo <HOST>:<PORT>
mongo <HOST>:<PORT>/<DB>
mongo <database> -u <username> -p '<password>'
```

The nmap script: _**mongodb-brute**_ will check if creds are needed.

```bash
nmap -n -sV --script mongodb-brute -p 27017 <ip>
```

### [**Brute force**](../generic-hacking/brute-force.md#mongo)

Look inside _/opt/bitnami/mongodb/mongodb.conf_ to know if credentials are needed:

```bash
grep "noauth.*true" /opt/bitnami/mongodb/mongodb.conf | grep -v "^#" #Not needed
grep "auth.*true" /opt/bitnami/mongodb/mongodb.conf | grep -v "^#\|noauth" #Not needed
```
MongoDB is a NoSQL database program. Default ports are 27017, 27018.

Enumeration
nmap --script mongodb-info -p 27017 <target-ip>
nmap --script mongodb-databases -p 27017 <target-ip>
Copied!
Brute Force Credentials
hydra -l username -P passwords.txt <target-ip> mysql
hydra -L usernames.txt -p password <target-ip> mysql
Copied!

Connect
### Local
mongo
mongo --port 27017

### Remote
mongo --host <target-ip> --port 27017 -u username -p password
mongo "mongodb://<target-ip>:27017"
mongo "mongodb://username:password@<target-ip>:27017/?authSource=admin"
Copied!

Basic Commands
### All databases
> show dbs
### Current database
> db
### Switch database if it exists, or create new if not exist
> use db_name
### Collections
> show collections
### Run javascript file
> load("example.js")

### List users in the current database
> show users
> db.admin.find()

### Create new collection in current database
> db.createCollection("users")
Copied!
CRUD
### Create
> db.<collection_name>.insert({id: "1", username: "admin"})
### Read
> db.<collection_name>.find()
> db.<collection_name>.findOne({"username":"michael"})
### Update
> db.<collection_name>.update({id: "1"}, {$set: {username: "king"}})
### Delete
> db.<collection_name>.remove({"name": "Micael"})
### Delete all documents
> db.<collection_name>.remove({})
Copied!
Operators
## $eq: equal
### ex. username is "admin"
db.<collection_name>.findOne({username: {"$eq": "admin"}})

## $ne: not equal
### ex. password is not "xyz"
db.<collection_name>.findOne({id: "1"}, {password: {"$ne": "xyz"}})

## $gt: greater than
### ex. id is greater than 2
db.<collection_name>.findOne({id: {"$gt": "2"}})

### $where:

### $exists:

$$# $regex: 
Copied!
Operators (Aggregation)
### $match: filter the documents to pass only the documents that match the specified conditions to the next pipeline stage.
{$match: { username: "admin" }}

### $lookup: join to a collection in the same database to filter in documents from the "joined" collection for processing.
{
    $lookup:
        {
            from: "users",
            localField: "_id",
            foreignField: "_id",
            as: "test"
        }
}
