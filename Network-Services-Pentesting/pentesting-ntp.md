# 123/udp - Pentesting NTP

## Basic Information

The **Network Time Protocol (NTP)** is used to synchronize the time of a computer client or server to another server or reference time source. Even though it's a simple and often overlooked protocol, it can be a valuable attack vector if not properly secured.

### Summary & Security Tips:

* **Purpose**: Syncs device clocks over networks.
* **Importance**: Critical for security, logging, and operations.
* **Security Measures**:
  * Use trusted NTP sources with authentication.
  * Limit NTP server network access.
  * Monitor synchronization for signs of tampering.

**Default port:** 123/udp

```
PORT    STATE SERVICE REASON
123/udp open  ntp     udp-response
```
## Connect
### Connect Using ntpq
To connect to an NTP server, you can manually query it using the ntpq command-line utility.
```
ntpq -p X.X.X.X
```
```bash
ntpq -c readlist <IP_ADDRESS>
ntpq -c readvar <IP_ADDRESS>
ntpq -c peers <IP_ADDRESS>
ntpq -c associations <IP_ADDRESS>
ntpdc -c monlist <IP_ADDRESS>
ntpdc -c listpeers <IP_ADDRESS>
ntpdc -c sysinfo <IP_ADDRESS>
```

```bash
nmap -sU -sV --script "ntp* and (discovery or vuln) and not (dos or brute)" -p 123 <IP>
```

## Examine configuration files

* ntp.conf

## NTP Amplification Attack

In this type of Distributed Denial of Service (DDoS) attack, an attacker exploits a vulnerable NTP server's monlist feature (which sends data about the last 600 hosts connecting to the server). The attacker spoofs their target's IP and sends a small query to the server, which responds by sending a large amount of data to the spoofed IP. This saturates the target's network with excessive traffic, disrupting its normal function.

Even though it's a simple protocol, NTP can be exploited if not properly secured. Keeping NTP servers updated and properly configured is essential for preventing such attacks.
```
# A simple ntpdc command to demonstrate interaction with monlist feature
# Note: Most modern NTP servers have this feature disabled due to its potential for misuse
ntpdc -n -c monlist [Target IP]
```

[**How NTP DDoS Attack Works**](https://resources.infosecinstitute.com/network-time-protocol-ntp-threats-countermeasures/#gref)

The **NTP protocol**, using UDP, allows for operation without the need for handshake procedures, unlike TCP. This characteristic is exploited in **NTP DDoS amplification attacks**. Here, attackers create packets with a fake source IP, making it seem as if the attack requests come from the victim. These packets, initially small, prompt the NTP server to respond with much larger data volumes, amplifying the attack.

The _**MONLIST**_ command, despite its rare use, can report the last 600 clients connected to the NTP service. While the command itself is simple, its misuse in such attacks highlights critical security vulnerabilities.

```bash
ntpdc -n -c monlist <IP>
```
## Post-Exploitation
## Changing Server Time
You could potentially adjust the time on the server and cause Havoc for any processes that are dependant on the system time.

To change the server time manually, use the following command
```
date -s "14 Oct 2020 18:00:00"
```
## Shodan

* `ntp`

## HackTricks Automatic Commands

```
Protocol_Name: NTP    #Protocol Abbreviation if there is one.
Port_Number:  123     #Comma separated if there is more than one.
Protocol_Description: Network Time Protocol         #Protocol Abbreviation Spelled out

Entry_1:
  Name: Notes
  Description: Notes for NTP
  Note: |
    The Network Time Protocol (NTP) ensures computers and network devices across variable-latency networks sync their clocks accurately. It's vital for maintaining precise timekeeping in IT operations, security, and logging. NTP's accuracy is essential, but it also poses security risks if not properly managed. 

    https://book.hacktricks.xyz/pentesting/pentesting-ntp

Entry_2:
  Name: Nmap
  Description: Enumerate NTP
  Command: nmap -sU -sV --script "ntp* and (discovery or vuln) and not (dos or brute)" -p 123 {IP}
```
